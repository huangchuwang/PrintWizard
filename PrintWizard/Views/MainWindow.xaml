<Window
    x:Class="PrintWizard.Views.MainWindow"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:common="clr-namespace:PrintWizard.Common"
    xmlns:local="clr-namespace:PrintWizard.Models"
    Title="标签打印设计器"
    Width="1000"
    Height="700"
    Background="#F0F2F5"
    WindowStartupLocation="CenterScreen">

    <Window.Resources>
        <common:BooleanToFontWeightConverter x:Key="BooleanToFontWeightConverter" />

        <Style x:Key="MiniDeleteBtnStyle" TargetType="Button">
            <Setter Property="Width" Value="12" />
            <Setter Property="Height" Value="12" />
            <Setter Property="Background" Value="#FF4d4f" />
            <Setter Property="Foreground" Value="White" />
            <Setter Property="BorderThickness" Value="0" />
            <Setter Property="Cursor" Value="Hand" />
            <Setter Property="Opacity" Value="0.8" />
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border Background="{TemplateBinding Background}" CornerRadius="6">
                            <TextBlock
                                Margin="0,-2,0,0"
                                HorizontalAlignment="Center"
                                VerticalAlignment="Center"
                                FontSize="8"
                                FontWeight="Bold"
                                Text="×" />
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
            <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Opacity" Value="1" />
                    <Setter Property="Background" Value="Red" />
                </Trigger>
            </Style.Triggers>
        </Style>

        <Style x:Key="MiniResizeHandleStyle" TargetType="Thumb">
            <Setter Property="Width" Value="8" />
            <Setter Property="Height" Value="8" />
            <Setter Property="Cursor" Value="SizeNWSE" />
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Thumb">
                        <Border
                            Background="White"
                            BorderBrush="#1890FF"
                            BorderThickness="1"
                            CornerRadius="1" />
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="ItemContainerBorder" TargetType="Rectangle">
            <Setter Property="Stroke" Value="#BFBFBF" />
            <Setter Property="StrokeThickness" Value="0.5" />
            <Setter Property="StrokeDashArray" Value="2 2" />
            <Setter Property="RadiusX" Value="1" />
            <Setter Property="RadiusY" Value="1" />
            <Setter Property="Fill" Value="Transparent" />
            <Setter Property="IsHitTestVisible" Value="False" />
        </Style>
    </Window.Resources>

    <Grid Margin="20">
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="*" />
            <ColumnDefinition Width="20" />
            <ColumnDefinition Width="320" />
        </Grid.ColumnDefinitions>

        <DockPanel Grid.Column="0">
            <TextBlock
                Margin="0,0,0,10"
                DockPanel.Dock="Top"
                FontSize="18"
                FontWeight="Bold"
                Foreground="#333"
                Text="设计预览" />

            <Border
                Padding="20"
                Background="White"
                BorderBrush="#D9D9D9"
                BorderThickness="1">
                <Border.Effect>
                    <DropShadowEffect
                        BlurRadius="10"
                        Opacity="0.1"
                        ShadowDepth="2"
                        Color="#000" />
                </Border.Effect>

                <Viewbox Stretch="Uniform">
                    <Border
                        Padding="{Binding PrintMargin}"
                        Background="White"
                        BorderBrush="#E8E8E8"
                        BorderThickness="1">
                        <Canvas
                            x:Name="ContentCanvas"
                            Width="{Binding PrintAreaWidth}"
                            Height="{Binding PrintAreaHeight}"
                            Background="White"
                            ClipToBounds="True">

                            <ItemsControl ItemsSource="{Binding PrintItems}">
                                <ItemsControl.ItemsPanel>
                                    <ItemsPanelTemplate>
                                        <Canvas />
                                    </ItemsPanelTemplate>
                                </ItemsControl.ItemsPanel>

                                <ItemsControl.ItemContainerStyle>
                                    <Style TargetType="ContentPresenter">
                                        <Setter Property="Canvas.Left" Value="{Binding X}" />
                                        <Setter Property="Canvas.Top" Value="{Binding Y}" />
                                        <EventSetter Event="PreviewMouseLeftButtonDown" Handler="Item_MouseDown" />
                                        <EventSetter Event="PreviewMouseMove" Handler="Item_MouseMove" />
                                        <EventSetter Event="PreviewMouseLeftButtonUp" Handler="Item_MouseUp" />
                                        <Setter Property="Cursor" Value="SizeAll" />
                                    </Style>
                                </ItemsControl.ItemContainerStyle>

                                <ItemsControl.Resources>
                                    <DataTemplate DataType="{x:Type local:TextPrintItem}">
                                        <Grid
                                            x:Name="ItemRoot"
                                            Width="{Binding Width, Mode=TwoWay}"
                                            Height="{Binding Height, Mode=TwoWay}">
                                            <Rectangle Style="{StaticResource ItemContainerBorder}" />

                                            <TextBox
                                                Padding="2"
                                                VerticalContentAlignment="Top"
                                                AcceptsReturn="True"
                                                Background="Transparent"
                                                BorderThickness="0"
                                                FontSize="{Binding FontSize}"
                                                FontWeight="{Binding IsBold, Converter={StaticResource BooleanToFontWeightConverter}}"
                                                IsHitTestVisible="True"
                                                Text="{Binding Content, UpdateSourceTrigger=PropertyChanged}"
                                                TextWrapping="Wrap" />

                                            <Thumb
                                                HorizontalAlignment="Right"
                                                VerticalAlignment="Bottom"
                                                DragDelta="Thumb_DragDelta"
                                                Style="{StaticResource MiniResizeHandleStyle}" />

                                            <Button
                                                Margin="0,-6,-6,0"
                                                HorizontalAlignment="Right"
                                                VerticalAlignment="Top"
                                                Command="{Binding DataContext.RemoveItemCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                CommandParameter="{Binding}"
                                                Style="{StaticResource MiniDeleteBtnStyle}"
                                                ToolTip="删除" />
                                        </Grid>
                                    </DataTemplate>

                                    <DataTemplate DataType="{x:Type local:QrCodePrintItem}">
                                        <Grid Width="{Binding Width, Mode=TwoWay}" Height="{Binding Height, Mode=TwoWay}">
                                            <Rectangle Style="{StaticResource ItemContainerBorder}" />

                                            <Image
                                                Margin="2"
                                                Source="{Binding QrImageSource}"
                                                Stretch="Fill" />

                                            <Thumb
                                                HorizontalAlignment="Right"
                                                VerticalAlignment="Bottom"
                                                DragDelta="Thumb_DragDelta"
                                                Style="{StaticResource MiniResizeHandleStyle}" />

                                            <Button
                                                Margin="0,-6,-6,0"
                                                HorizontalAlignment="Right"
                                                VerticalAlignment="Top"
                                                Command="{Binding DataContext.RemoveItemCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                CommandParameter="{Binding}"
                                                Style="{StaticResource MiniDeleteBtnStyle}"
                                                ToolTip="删除" />
                                        </Grid>
                                    </DataTemplate>
                                </ItemsControl.Resources>
                            </ItemsControl>
                        </Canvas>
                    </Border>
                </Viewbox>
            </Border>
        </DockPanel>

        <StackPanel Grid.Column="2">
            <GroupBox
                Margin="0,0,0,10"
                Padding="10"
                Header="页面设置">
                <StackPanel>
                    <DockPanel Margin="0,0,0,5">
                        <TextBlock
                            Width="40"
                            VerticalAlignment="Center"
                            Text="纸张:" />
                        <ComboBox
                            DisplayMemberPath="Name"
                            ItemsSource="{Binding PaperSizes}"
                            SelectedItem="{Binding SelectedPaperSize}" />
                    </DockPanel>
                    <DockPanel Margin="0,0,0,5">
                        <TextBlock
                            Width="40"
                            VerticalAlignment="Center"
                            Text="边距:" />
                        <ComboBox
                            DisplayMemberPath="DisplayName"
                            ItemsSource="{Binding Margins}"
                            SelectedItem="{Binding SelectedMargin}" />
                    </DockPanel>
                    <TextBlock
                        HorizontalAlignment="Right"
                        FontSize="11"
                        Foreground="Gray"
                        Text="{Binding PrintAreaSizeInfo}" />
                </StackPanel>
            </GroupBox>

            <GroupBox
                Margin="0,0,0,10"
                Padding="10"
                Header="添加元素">
                <StackPanel>
                    <TextBlock Margin="0,0,0,5" Text="文本内容:" />
                    <TextBox
                        Height="60"
                        Margin="0,0,0,5"
                        AcceptsReturn="True"
                        Text="{Binding NewItemText, UpdateSourceTrigger=PropertyChanged}"
                        TextWrapping="Wrap" />
                    <DockPanel Margin="0,0,0,5">
                        <TextBlock VerticalAlignment="Center" Text="字号:" />
                        <Slider
                            Width="150"
                            Margin="5,0"
                            Maximum="72"
                            Minimum="2"
                            Value="{Binding NewItemFontSize}" />
                        <TextBlock VerticalAlignment="Center" Text="{Binding NewItemFontSize}" />
                    </DockPanel>
                    <CheckBox
                        Margin="0,0,0,10"
                        Content="加粗文本"
                        IsChecked="{Binding NewItemIsBold}" />
                    <Button
                        Margin="0,0,0,15"
                        Padding="5"
                        Command="{Binding AddTextItemCommand}"
                        Content="+ 添加文本" />
                    <Separator Margin="0,0,0,10" />
                    <TextBlock Margin="0,0,0,5" Text="二维码内容:" />
                    <TextBox Margin="0,0,0,5" Text="{Binding NewQrCodeContent, UpdateSourceTrigger=PropertyChanged}" />
                    <Button
                        Padding="5"
                        Command="{Binding AddQrCodeItemCommand}"
                        Content="+ 添加二维码" />
                </StackPanel>
            </GroupBox>

            <GroupBox Padding="10" Header="输出与操作">
                <StackPanel>
                    <DockPanel Margin="0,0,0,10">
                        <TextBlock
                            Width="40"
                            VerticalAlignment="Center"
                            Text="份数:" />
                        <TextBox
                            Width="50"
                            HorizontalAlignment="Left"
                            Text="{Binding Copies}" />
                        <Button
                            Padding="5,2"
                            HorizontalAlignment="Right"
                            Command="{Binding ResetPositionCommand}"
                            Content="重置位置" />
                    </DockPanel>
                    <Button
                        Margin="0,0,0,5"
                        Padding="8"
                        Background="#17A2B8"
                        Command="{Binding ImportCpclCommand}"
                        Content="导入 CPCL 文件"
                        Foreground="White" />
                    <Button
                        Margin="0,0,0,5"
                        Padding="8"
                        Background="#28A745"
                        Command="{Binding ExportCpclCommand}"
                        Content="导出 CPCL 指令"
                        Foreground="White" />
                    <Button
                        Padding="8"
                        Background="#0078D4"
                        Command="{Binding PrintCommand}"
                        Content="直接打印"
                        FontWeight="Bold"
                        Foreground="White" />
                </StackPanel>
            </GroupBox>

            <Border
                Margin="0,10,0,0"
                Padding="5"
                Background="#E6F7FF"
                BorderBrush="#91D5FF"
                BorderThickness="1">
                <TextBlock
                    Foreground="#0050B3"
                    Text="{Binding StatusMessage}"
                    TextWrapping="Wrap" />
            </Border>
        </StackPanel>
    </Grid>
</Window>