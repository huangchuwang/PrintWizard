<Window
    x:Class="PrintWizard.Views.MainWindow"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:common="clr-namespace:PrintWizard.Common"
    xmlns:local="clr-namespace:PrintWizard.Models"
    Title="标签打印设计器 - PrintWizard"
    Width="1100"
    Height="760"
    Background="#F5F6F8"
    FontFamily="Segoe UI, Microsoft YaHei"
    WindowStartupLocation="CenterScreen">

    <Window.Resources>
        <SolidColorBrush x:Key="PrimaryBlue" Color="#0078D4" />
        <SolidColorBrush x:Key="PrimaryBlueHover" Color="#0062AD" />
        <SolidColorBrush x:Key="TextDark" Color="#323130" />
        <SolidColorBrush x:Key="TextGray" Color="#605E5C" />
        <SolidColorBrush x:Key="CardBackground" Color="#FFFFFF" />
        <SolidColorBrush x:Key="BorderLight" Color="#E1DFDD" />

        <common:BooleanToFontWeightConverter x:Key="BooleanToFontWeightConverter" />

        <Style x:Key="CardStyle" TargetType="Border">
            <Setter Property="Background" Value="{StaticResource CardBackground}" />
            <Setter Property="CornerRadius" Value="8" />
            <Setter Property="Margin" Value="0,0,0,16" />
            <Setter Property="BorderBrush" Value="{StaticResource BorderLight}" />
            <Setter Property="BorderThickness" Value="1" />
            <Setter Property="Effect">
                <Setter.Value>
                    <DropShadowEffect
                        BlurRadius="10"
                        Direction="270"
                        Opacity="0.05"
                        ShadowDepth="2"
                        Color="Black" />
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="CardHeaderStyle" TargetType="TextBlock">
            <Setter Property="FontSize" Value="14" />
            <Setter Property="FontWeight" Value="SemiBold" />
            <Setter Property="Foreground" Value="{StaticResource TextDark}" />
            <Setter Property="Margin" Value="0,0,0,12" />
        </Style>

        <Style x:Key="PrimaryButtonStyle" TargetType="Button">
            <Setter Property="Background" Value="{StaticResource PrimaryBlue}" />
            <Setter Property="Foreground" Value="White" />
            <Setter Property="Padding" Value="12,8" />
            <Setter Property="BorderThickness" Value="0" />
            <Setter Property="FontWeight" Value="SemiBold" />
            <Setter Property="Cursor" Value="Hand" />
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border
                            x:Name="border"
                            Background="{TemplateBinding Background}"
                            BorderBrush="{TemplateBinding BorderBrush}"
                            BorderThickness="{TemplateBinding BorderThickness}"
                            CornerRadius="4">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center" />
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="{StaticResource PrimaryBlueHover}" />
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter TargetName="border" Property="Opacity" Value="0.8" />
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter TargetName="border" Property="Background" Value="#CCCCCC" />
                                <Setter TargetName="border" Property="Opacity" Value="0.6" />
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="SecondaryButtonStyle" TargetType="Button">
            <Setter Property="Background" Value="White" />
            <Setter Property="Foreground" Value="{StaticResource TextDark}" />
            <Setter Property="BorderBrush" Value="#CCCCCC" />
            <Setter Property="BorderThickness" Value="1" />
            <Setter Property="Padding" Value="10,6" />
            <Setter Property="Cursor" Value="Hand" />
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border
                            x:Name="border"
                            Background="{TemplateBinding Background}"
                            BorderBrush="{TemplateBinding BorderBrush}"
                            BorderThickness="{TemplateBinding BorderThickness}"
                            CornerRadius="4">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center" />
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="border" Property="Background" Value="#F3F2F1" />
                                <Setter TargetName="border" Property="BorderBrush" Value="#999999" />
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="MiniDeleteBtnStyle" TargetType="Button">
            <Setter Property="Width" Value="6" />
            <Setter Property="Height" Value="6" />
            <Setter Property="Background" Value="#FF4d4f" />
            <Setter Property="Foreground" Value="White" />
            <Setter Property="BorderThickness" Value="0" />
            <Setter Property="Cursor" Value="Hand" />
            <Setter Property="Opacity" Value="0.6" />
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border Background="{TemplateBinding Background}" CornerRadius="6">
                            <TextBlock
                                Margin="0,-2,0,0"
                                HorizontalAlignment="Center"
                                VerticalAlignment="Center"
                                FontSize="8"
                                FontWeight="Bold"
                                Text="×" />
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
            <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Opacity" Value="1" />
                    <Setter Property="Background" Value="#D9363E" />
                </Trigger>
            </Style.Triggers>
        </Style>

        <Style x:Key="MiniResizeHandleStyle" TargetType="Thumb">
            <Setter Property="Width" Value="6" />
            <Setter Property="Height" Value="6" />
            <Setter Property="Cursor" Value="SizeNWSE" />
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Thumb">
                        <Border
                            Background="White"
                            BorderBrush="{StaticResource PrimaryBlue}"
                            BorderThickness="1"
                            CornerRadius="5" />
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="ItemContainerBorder" TargetType="Rectangle">
            <Setter Property="Stroke" Value="#BFBFBF" />
            <Setter Property="StrokeThickness" Value="0.5" />
            <Setter Property="StrokeDashArray" Value="4 2" />
            <Setter Property="RadiusX" Value="2" />
            <Setter Property="RadiusY" Value="2" />
            <Setter Property="Fill" Value="Transparent" />
            <Setter Property="IsHitTestVisible" Value="False" />
        </Style>

        <Style x:Key="InputLabel" TargetType="TextBlock">
            <Setter Property="Foreground" Value="{StaticResource TextGray}" />
            <Setter Property="VerticalAlignment" Value="Center" />
            <Setter Property="Margin" Value="0,0,8,0" />
            <Setter Property="Width" Value="50" />
        </Style>
    </Window.Resources>

    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="*" />
            <ColumnDefinition Width="360" />
        </Grid.ColumnDefinitions>

        <Grid Grid.Column="0" Margin="20">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto" />
                <RowDefinition Height="*" />
            </Grid.RowDefinitions>

            <StackPanel Margin="0,0,0,15" Orientation="Horizontal">
                <TextBlock
                    Margin="0,0,10,0"
                    FontSize="20"
                    Text="🏷️" />
                <TextBlock
                    VerticalAlignment="Center"
                    FontSize="20"
                    FontWeight="Bold"
                    Foreground="{StaticResource TextDark}"
                    Text="打印设计预览" />
                <TextBlock
                    Margin="15,0,0,0"
                    VerticalAlignment="Bottom"
                    FontSize="12"
                    Foreground="{StaticResource TextGray}"
                    Text="{Binding PrintAreaSizeInfo}" />
            </StackPanel>

            <Border
                Grid.Row="1"
                Background="#E3E5E8"
                ClipToBounds="True"
                CornerRadius="8">
                <Grid>
                    <Viewbox Margin="40">
                        <Border
                            Background="White"
                            BorderBrush="#D1D1D1"
                            BorderThickness="1">
                            <Border.Effect>
                                <DropShadowEffect
                                    BlurRadius="20"
                                    Opacity="0.2"
                                    ShadowDepth="5"
                                    Color="Black" />
                            </Border.Effect>

                            <Border
                                Padding="{Binding PrintMargin}"
                                Background="Transparent"
                                ClipToBounds="True">
                                <Canvas
                                    x:Name="ContentCanvas"
                                    Width="{Binding PrintAreaWidth}"
                                    Height="{Binding PrintAreaHeight}"
                                    Background="Transparent">

                                    <ItemsControl ItemsSource="{Binding PrintItems}">
                                        <ItemsControl.ItemsPanel>
                                            <ItemsPanelTemplate>
                                                <Canvas />
                                            </ItemsPanelTemplate>
                                        </ItemsControl.ItemsPanel>

                                        <ItemsControl.ItemContainerStyle>
                                            <Style TargetType="ContentPresenter">
                                                <Setter Property="Canvas.Left" Value="{Binding X}" />
                                                <Setter Property="Canvas.Top" Value="{Binding Y}" />
                                                <EventSetter Event="PreviewMouseLeftButtonDown" Handler="Item_MouseDown" />
                                                <EventSetter Event="PreviewMouseMove" Handler="Item_MouseMove" />
                                                <EventSetter Event="PreviewMouseLeftButtonUp" Handler="Item_MouseUp" />
                                                <Setter Property="Cursor" Value="SizeAll" />
                                            </Style>
                                        </ItemsControl.ItemContainerStyle>

                                        <ItemsControl.Resources>
                                            <DataTemplate DataType="{x:Type local:TextPrintItem}">
                                                <Grid
                                                    x:Name="ItemRoot"
                                                    Width="{Binding Width, Mode=TwoWay}"
                                                    Height="{Binding Height, Mode=TwoWay}">

                                                    <Rectangle Style="{StaticResource ItemContainerBorder}" />

                                                    <TextBox
                                                        Padding="4"
                                                        VerticalContentAlignment="Top"
                                                        AcceptsReturn="True"
                                                        Background="Transparent"
                                                        BorderThickness="0"
                                                        FontSize="{Binding FontSize}"
                                                        FontWeight="{Binding IsBold, Converter={StaticResource BooleanToFontWeightConverter}}"
                                                        IsHitTestVisible="True"
                                                        Text="{Binding Content, UpdateSourceTrigger=PropertyChanged}"
                                                        TextWrapping="Wrap" />

                                                    <Thumb
                                                        HorizontalAlignment="Right"
                                                        VerticalAlignment="Bottom"
                                                        DragDelta="Thumb_DragDelta"
                                                        Style="{StaticResource MiniResizeHandleStyle}" />

                                                    <Button
                                                        HorizontalAlignment="Right"
                                                        VerticalAlignment="Top"
                                                        Command="{Binding DataContext.RemoveItemCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                        CommandParameter="{Binding}"
                                                        Style="{StaticResource MiniDeleteBtnStyle}"
                                                        ToolTip="删除" />
                                                </Grid>
                                            </DataTemplate>

                                            <DataTemplate DataType="{x:Type local:QrCodePrintItem}">
                                                <Grid Width="{Binding Width, Mode=TwoWay}" Height="{Binding Height, Mode=TwoWay}">

                                                    <Rectangle Style="{StaticResource ItemContainerBorder}" />

                                                    <Image
                                                        Margin="2"
                                                        Source="{Binding QrImageSource}"
                                                        Stretch="Fill" />

                                                    <Thumb
                                                        HorizontalAlignment="Right"
                                                        VerticalAlignment="Bottom"
                                                        DragDelta="Thumb_DragDelta"
                                                        Style="{StaticResource MiniResizeHandleStyle}" />

                                                    <Button
                                                        HorizontalAlignment="Right"
                                                        VerticalAlignment="Top"
                                                        Command="{Binding DataContext.RemoveItemCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                        CommandParameter="{Binding}"
                                                        Style="{StaticResource MiniDeleteBtnStyle}"
                                                        ToolTip="删除" />
                                                </Grid>
                                            </DataTemplate>
                                        </ItemsControl.Resources>
                                    </ItemsControl>
                                </Canvas>
                            </Border>
                        </Border>
                    </Viewbox>
                </Grid>
            </Border>
        </Grid>

        <Border
            Grid.Column="1"
            Background="White"
            BorderBrush="{StaticResource BorderLight}"
            BorderThickness="1,0,0,0">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="*" />
                    <RowDefinition Height="Auto" />
                </Grid.RowDefinitions>

                <TextBlock
                    Margin="20,20,20,10"
                    FontSize="18"
                    FontWeight="Bold"
                    Text="工具箱" />

                <ScrollViewer
                    Grid.Row="1"
                    Padding="20,10,20,20"
                    VerticalScrollBarVisibility="Auto">
                    <StackPanel>

                        <Border Padding="16" Style="{StaticResource CardStyle}">
                            <StackPanel>
                                <TextBlock Style="{StaticResource CardHeaderStyle}" Text="页面设置" />

                                <DockPanel Margin="0,0,0,10">
                                    <TextBlock Style="{StaticResource InputLabel}" Text="打印机" />
                                    <ComboBox
                                        DisplayMemberPath="Name"
                                        ItemsSource="{Binding AvailablePrinters}"
                                        SelectedItem="{Binding SelectedPrinter}" />
                                </DockPanel>

                                <DockPanel Margin="0,0,0,10">
                                    <TextBlock Style="{StaticResource InputLabel}" Text="纸张" />
                                    <ComboBox
                                        DisplayMemberPath="Name"
                                        ItemsSource="{Binding PaperSizes}"
                                        SelectedItem="{Binding SelectedPaperSize}" />
                                </DockPanel>

                                <DockPanel>
                                    <TextBlock Style="{StaticResource InputLabel}" Text="边距" />
                                    <ComboBox
                                        DisplayMemberPath="DisplayName"
                                        ItemsSource="{Binding Margins}"
                                        SelectedItem="{Binding SelectedMargin}" />
                                </DockPanel>
                            </StackPanel>
                        </Border>

                        <Border Padding="16" Style="{StaticResource CardStyle}">
                            <StackPanel>
                                <TextBlock Style="{StaticResource CardHeaderStyle}" Text="添加内容" />

                                <TextBlock
                                    Margin="0,0,0,4"
                                    FontSize="12"
                                    Foreground="{StaticResource TextGray}"
                                    Text="文本内容" />
                                <TextBox
                                    Height="60"
                                    Margin="0,0,0,8"
                                    Padding="5"
                                    VerticalContentAlignment="Top"
                                    AcceptsReturn="True"
                                    Text="{Binding NewItemText, UpdateSourceTrigger=PropertyChanged}"
                                    TextWrapping="Wrap" />

                                <DockPanel Margin="0,0,0,8">
                                    <TextBlock
                                        Width="40"
                                        Style="{StaticResource InputLabel}"
                                        Text="字号" />
                                    <TextBlock
                                        Width="25"
                                        VerticalAlignment="Center"
                                        FontWeight="Bold"
                                        Text="{Binding NewItemFontSize}" />
                                    <Slider
                                        VerticalAlignment="Center"
                                        IsSnapToTickEnabled="True"
                                        Maximum="72"
                                        Minimum="12"
                                        TickFrequency="1"
                                        Value="{Binding NewItemFontSize}" />
                                </DockPanel>

                                <CheckBox
                                    Margin="0,0,0,12"
                                    Content="加粗文本"
                                    IsChecked="{Binding NewItemIsBold}" />

                                <Button
                                    Margin="0,0,0,20"
                                    Command="{Binding AddTextItemCommand}"
                                    Content="+ 添加文本对象"
                                    Style="{StaticResource SecondaryButtonStyle}" />

                                <Border
                                    Height="1"
                                    Margin="0,0,0,15"
                                    Background="#EEEEEE" />

                                <TextBlock
                                    Margin="0,0,0,4"
                                    FontSize="12"
                                    Foreground="{StaticResource TextGray}"
                                    Text="二维码内容" />
                                <TextBox
                                    Margin="0,0,0,12"
                                    Padding="5"
                                    Text="{Binding NewQrCodeContent, UpdateSourceTrigger=PropertyChanged}" />

                                <Button
                                    Command="{Binding AddQrCodeItemCommand}"
                                    Content="+ 添加二维码"
                                    Style="{StaticResource SecondaryButtonStyle}" />
                            </StackPanel>
                        </Border>

                        <Border Padding="16" Style="{StaticResource CardStyle}">
                            <StackPanel>
                                <TextBlock Style="{StaticResource CardHeaderStyle}" Text="输出与操作" />

                                <DockPanel Margin="0,0,0,15">
                                    <TextBlock
                                        Width="60"
                                        Style="{StaticResource InputLabel}"
                                        Text="打印份数" />
                                    <TextBox
                                        Width="60"
                                        HorizontalAlignment="Left"
                                        Text="{Binding Copies}"
                                        TextAlignment="Center" />
                                    <Button
                                        HorizontalAlignment="Right"
                                        Command="{Binding ResetPositionCommand}"
                                        Content="重置位置"
                                        FontSize="11"
                                        Style="{StaticResource SecondaryButtonStyle}" />
                                </DockPanel>

                                <Grid Margin="0,0,0,10">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*" />
                                        <ColumnDefinition Width="10" />
                                        <ColumnDefinition Width="*" />
                                    </Grid.ColumnDefinitions>
                                    <Button
                                        Grid.Column="0"
                                        Background="#F3F0FA"
                                        BorderBrush="#DCCBF7"
                                        Command="{Binding ImportConfigCommand}"
                                        Content="导入配置"
                                        Style="{StaticResource SecondaryButtonStyle}" />
                                    <Button
                                        Grid.Column="2"
                                        Background="#F3F0FA"
                                        BorderBrush="#DCCBF7"
                                        Command="{Binding ExportConfigCommand}"
                                        Content="导出配置"
                                        Style="{StaticResource SecondaryButtonStyle}" />
                                </Grid>

                                <Grid Margin="0,0,0,15">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*" />
                                        <ColumnDefinition Width="10" />
                                        <ColumnDefinition Width="*" />
                                    </Grid.ColumnDefinitions>
                                    <Button
                                        Grid.Column="0"
                                        Command="{Binding ImportCpclCommand}"
                                        Content="导入 CPCL"
                                        Style="{StaticResource SecondaryButtonStyle}" />
                                    <Button
                                        Grid.Column="2"
                                        Command="{Binding ExportCpclCommand}"
                                        Content="导出 CPCL"
                                        Style="{StaticResource SecondaryButtonStyle}" />
                                </Grid>

                                <Button
                                    Height="40"
                                    Command="{Binding PrintCommand}"
                                    Content="开始打印"
                                    FontSize="16"
                                    Style="{StaticResource PrimaryButtonStyle}" />
                            </StackPanel>
                        </Border>

                    </StackPanel>
                </ScrollViewer>

                <Border
                    Grid.Row="2"
                    Padding="15,10"
                    Background="#F0F8FF"
                    BorderBrush="#CCE4F7"
                    BorderThickness="0,1,0,0">
                    <DockPanel>
                        <TextBlock
                            Margin="0,0,8,0"
                            VerticalAlignment="Center"
                            Text="ℹ️" />
                        <TextBlock
                            FontSize="12"
                            Foreground="#005A9E"
                            Text="{Binding StatusMessage}"
                            TextWrapping="Wrap" />
                    </DockPanel>
                </Border>
            </Grid>
        </Border>
    </Grid>
</Window>